
## 2026-02-17 12:42 - US-002: Add host key verification policy enum
- Added `HostKeyPolicy` enum to protocols.py with AUTO_ADD, STRICT, PROMPT values
- Added `host_key_policy` field to `ConnectionInfo` dataclass with default AUTO_ADD
- Files changed: src/portkeydrop/protocols.py, tests/test_host_key_policy.py
- **Learnings:** ConnectionInfo is a dataclass so adding fields with defaults is straightforward
---

## 2026-02-17 12:47 - US-003: Update SFTPClient to use SSHClient instead of Transport
- Replaced `self._transport` with `self._ssh_client` (paramiko.SSHClient) in SFTPClient
- Updated `connect()` to use `SSHClient.connect()` with `allow_agent=True`, `look_for_keys=True`
- Host key policy from `ConnectionInfo.host_key_policy` applied (AUTO_ADD→AutoAddPolicy, STRICT→RejectPolicy)
- Key file auth disables agent/look_for_keys; password auth still passed through; no creds = agent-only
- Added TYPE_CHECKING import for paramiko in protocols.py
- Files changed: src/portkeydrop/protocols.py, tests/test_sftp_client.py (9 tests)
- **Learnings:** paramiko is imported locally in connect(); patch `paramiko.SSHClient` not `module.paramiko`
---

## 2026-02-17 13:07 - US-005: Update SFTPClient _ensure_connected method
- Updated `_ensure_connected()` to check `_ssh_client` instead of `_connected` flag, plus `_sftp`
- Added return type annotation `-> paramiko.SFTPClient`
- Added 5 tests: ssh_client None, sftp None, both None, returns sftp, methods use ensure_connected
- Files changed: src/portkeydrop/protocols.py, tests/test_sftp_client.py
---

## 2026-02-18 00:23 UTC - US-008: Update existing SFTPClient tests for SSHClient
- Updated `tests/test_protocols.py` SFTPClient tests to mock `paramiko.SSHClient` instead of transport-based behavior
- Added/updated connect success assertion to verify `SSHClient.connect()` kwargs (hostname/port/username/timeout/allow_agent/look_for_keys/password)
- Added connect failure test for SSHClient connection exceptions and disconnect test verifying both `SFTPClient.close()` and `SSHClient.close()` are called
- Files changed: tests/test_protocols.py
- **Learnings:** In this codebase, SFTP unit tests typically patch `paramiko.SSHClient` and assert against `connect.call_args[1]` for auth-flow parameters
---

## 2026-02-18 00:32 UTC - US-008 (retry): Raise SFTPClient test coverage and fix lint gate
- Expanded `tests/test_protocols.py` with additional SFTPClient tests covering list_dir parsing, chdir, download/upload callbacks, delete/mkdir/rmdir/rename, key-path auth flags, and stat mapping.
- Kept SSHClient-based mocking throughout to align with production auth flow.
- Fixed `ruff` failure by removing an unused import in `src/portkeydrop/dialogs/transfer.py`.
- Files changed: tests/test_protocols.py, src/portkeydrop/dialogs/transfer.py
- **Learnings:** High-leverage coverage for callback APIs comes from driving mocked side_effect callbacks and asserting propagated transfer metrics.
---

## 2026-02-18 00:44 UTC - US-009: Add SSH agent status logging and error handling
- Enhanced `SFTPClient.connect()` with debug logging for host key policy, system host key loading, SSH agent detection signals (`SSH_AUTH_SOCK`, OpenSSH Windows pipe, Pageant status), and attempted auth methods.
- Added explicit error handling for `BadHostKeyException`, `PasswordRequiredException`, `AuthenticationException`, `NoValidConnectionsError`, and `SSHException` (including agent-specific SSHException handling) with actionable `ConnectionError` messages.
- Preserved backward compatibility by keeping `ConnectionError` messages prefixed with `SFTP connection failed:` while distinguishing failure scenarios.
- Added logging-focused and message-focused tests in `tests/test_sftp_client.py` covering auth method logging, agent-unavailable logging, and differentiated auth failure messaging.
- Files changed: src/portkeydrop/protocols.py, tests/test_sftp_client.py, progress-d17d6391-cbc7-46b6-a7ed-74275fb33f6e.txt
- **Learnings:** `caplog.set_level(..., logger="portkeydrop.protocols")` is a stable pattern here for asserting protocol-layer logs without over-capturing unrelated logger output.
---
